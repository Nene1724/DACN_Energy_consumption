<!-- Deployment View -->
<div id="deployment_view" class="hidden">
    <div id="alert_container" class="alert-stack"></div>

    <div class="grid">
        <div class="col-left">
            <div class="panel">
                <div class="panel-header">
                    <div>
                        <h3>Balena Cloud</h3>
                        <p class="muted">Select device and deploy models</p>
                    </div>
                    <button class="btn ghost" id="balena_refresh_btn" type="button">Refresh</button>
                </div>
                
                <!-- Fleet and device filters -->
                <div class="form-grid" style="margin-bottom: 14px;">
                    <div class="form-control">
                        <label for="balena_app_filter">Fleet</label>
                        <select id="balena_app_filter" class="filter-select" style="width: 100%;">
                            <option value="">All fleets</option>
                        </select>
                    </div>
                    <label style="display:flex; align-items:center; gap:8px; color: var(--muted); font-size: 13px; margin-top: 8px; cursor: pointer;">
                        <input type="checkbox" id="balena_online_only" style="width: 16px; height: 16px; cursor: pointer;">
                        Show online only
                    </label>
                </div>
                
                <!-- Device selector -->
                <div class="form-grid">
                    <div class="form-control">
                        <label for="deploy_device_list">Devices</label>
                        <div id="deploy_device_list" class="device-list">
                            <div style="text-align: center; padding: 30px 20px; color: var(--muted); font-size: 13px;">
                                <div style="font-size: 32px; margin-bottom: 8px; opacity: 0.5;">üì°</div>
                                Click "Refresh" button above to load devices
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; padding: 8px 12px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.15);">
                            <small class="text-muted" style="font-size: 12px; color: var(--muted);">
                                Selected
                            </small>
                            <strong id="selected_devices_count" style="font-size: 16px; color: var(--accent); font-weight: 700;">0</strong>
                        </div>
                    </div>
                    
                    <!-- Device specifications -->
                    <div id="device_specs" class="selection-preview" style="margin-top: 8px; display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong id="device_specs_name">Device Name</strong>
                            <span class="badge ok" id="device_specs_status">ONLINE</span>
                        </div>
                        <div style="color: var(--muted); font-size: 13px; display: flex; flex-direction: column; gap: 4px;">
                            <div><strong>Type:</strong> <span id="device_specs_type">‚Äî</span></div>
                            <div><strong>OS:</strong> <span id="device_specs_os">‚Äî</span></div>
                            <div><strong>Specs:</strong> <span id="device_specs_hardware">‚Äî</span></div>
                            <div><strong>UUID:</strong> <span id="device_specs_uuid" style="font-family: monospace; font-size: 11px;">‚Äî</span></div>
                        </div>
                    </div>
                    
                    <!-- Load models button -->
                    <div style="display:flex; gap:10px; margin-top: 14px;">
                        <button class="btn primary full" onclick="loadAllModels()" style="font-weight: 600; padding: 14px;">
                            Load Models
                        </button>
                    </div>
                </div>
                
                <!-- Device Model Status -->
                <div class="panel" id="device_model_status_panel" style="margin-top: 16px;">
                    <div class="panel-header">
                        <div>
                            <h3>Device Model Status</h3>
                            <p class="muted" style="font-size: 12px; margin-top: 4px;">Real-time status of online devices</p>
                        </div>
                        <button class="btn ghost" onclick="refreshDeviceModelStatus()" style="font-size: 12px; padding: 6px 12px;">Refresh</button>
                    </div>
                    <div id="device_model_status_list" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
                
                <div class="status-block" id="rerun_container" style="margin-top:8px; display:none;">
                    <button class="btn primary full" id="rerun_btn" type="button">Re-run last deployment</button>
                    <p class="muted" id="rerun_caption" style="font-size:12px; margin-top:6px;">‚Äî</p>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h3>Energy Prediction</h3>
                </div>
                <p class="muted" style="font-size:13px; margin-bottom:10px;">Predict energy consumption for popular models before deployment</p>
                
                <!-- Device type selector -->
                <div class="form-control" style="margin-bottom: 12px;">
                    <label for="pred_device_type">Target Device</label>
                    <select id="pred_device_type" class="filter-select" style="width: 100%;">
                        <option value="jetson_nano">Jetson Nano (MAPE: Loading...)</option>
                        <option value="raspberry_pi5">Raspberry Pi 5 (MAPE: Loading...)</option>
                    </select>
                </div>
                
                <!-- Popular models selector -->
                <div class="form-control" style="margin-bottom: 12px;">
                    <label for="popular_model_selector">Select popular model</label>
                    <select id="popular_model_selector" class="filter-select" style="width: 100%;" onchange="fillPopularModelFields()">
                        <option value="">Loading popular models...</option>
                    </select>
                </div>
                
                <div class="predict-grid">
                    <div class="form-control">
                        <label>Params (M)</label>
                        <input type="text" id="pred_params_m" placeholder="0" style="background:#fff;">
                    </div>
                    <div class="form-control">
                        <label>GFLOPs</label>
                        <input type="text" id="pred_gflops" placeholder="0" style="background:#fff;">
                    </div>
                    <div class="form-control">
                        <label>GMACs</label>
                        <input type="text" id="pred_gmacs" placeholder="0" style="background:#fff;">
                    </div>
                    <div class="form-control">
                        <label>Size (MB)</label>
                        <input type="text" id="pred_size_mb" placeholder="0" style="background:#fff;">
                    </div>
                    <div class="form-control">
                        <label>Latency (s)</label>
                        <input type="text" id="pred_latency" placeholder="0" style="background:#fff;">
                    </div>
                    <div class="form-control">
                        <label>Throughput (iter/s)</label>
                        <input type="text" id="pred_throughput" placeholder="0" style="background:#fff;">
                    </div>
                </div>
                
                <!-- Predict button -->
                <button class="btn primary full" id="predict_energy_btn" style="margin-top: 12px; font-weight: 600; padding: 14px;">
                    Predict Energy
                </button>
                
                <div class="predict-output" id="predict_output">Fill the fields and click "Predict".</div>
            </div>
        </div>

        <div class="col-right">
            <div class="panel">
                <div class="panel-header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <h3>Available Models</h3>
                        <span id="filter_result_note" style="color: var(--muted); font-size: 13px; font-weight: 500;">
                            0 models (All models)
                        </span>
                    </div>
                    <div class="panel-actions">
                        <input type="text" id="search_input" placeholder="Search models..." style="padding:10px 12px; border:1px solid var(--border); border-radius:8px; font-size:13px; width:200px;">
                        <select id="filter_select" class="filter-select">
                            <option value="all">All models</option>
                            <option value="recommended">Recommended</option>
                            <option value="under_50">Under 50 mWh</option>
                            <option value="under_100">Under 100 mWh</option>
                        </select>
                    </div>
                </div>
                
                <div class="model-grid" id="model_grid">
                    <div class="loading-placeholder">Loading models...</div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <div>
                        <h3>Deployment Logs</h3>
                        <p class="muted" style="font-size:12px; margin-top:4px;">Last 50 deployments</p>
                    </div>
                    <button class="btn ghost" id="logs_refresh_btn">Refresh</button>
                </div>
                <div id="logs_container" class="log-list"></div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variable for models data
window.popularModels = {};
window.selectedModelName = null;

// Fetch and update MAPE values dynamically
async function updateMapeValues() {
    try {
        const response = await fetch('/api/energy/metadata');
        const data = await response.json();
        
        if (data.success && data.metadata) {
            const jetsonMape = data.metadata.jetson_model?.metrics?.test_mape || 21.5;
            const rpi5Mape = data.metadata.rpi5_model?.metrics?.loo_mape || 14.2;
            
            const deviceSelect = document.getElementById('pred_device_type');
            if (deviceSelect) {
                deviceSelect.innerHTML = `
                    <option value="jetson_nano">Jetson Nano (MAPE: ${jetsonMape.toFixed(1)}%)</option>
                    <option value="raspberry_pi5">Raspberry Pi 5 (MAPE: ${rpi5Mape.toFixed(1)}%)</option>
                `;
            }
        }
    } catch (err) {
        console.error('Failed to fetch MAPE values:', err);
    }
}

// Load popular models from API
async function loadPopularModels(deviceType = null) {
    const modelSelect = document.getElementById('popular_model_selector');
    if (!modelSelect) return;
    
    try {
        modelSelect.innerHTML = '<option value="">Loading popular models...</option>';
        
        // Build URL with optional device filter
        let url = '/api/models/popular';
        if (deviceType) {
            url += `?device=${deviceType}`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success && data.models) {
            window.popularModels = {};  // Reset global
            let html = '<option value="">Choose a popular model...</option>';
            
            // Group by family
            const families = {};
            data.models.forEach(model => {
                const family = model.family || 'Other';
                if (!families[family]) {
                    families[family] = [];
                }
                families[family].push(model);
            });
            
            // Add optgroups for each family
            Object.keys(families).sort().forEach(family => {
                html += `<optgroup label="${family}">`;
                families[family].forEach(model => {
                    window.popularModels[model.name] = model;
                    html += `<option value="${model.name}">${model.display_name} (${model.params_m}M params)</option>`;
                });
                html += '</optgroup>';
            });
            
            modelSelect.innerHTML = html;
            console.log('Loaded', data.models.length, 'popular models');
        }
    } catch (err) {
        console.error('Failed to load popular models:', err);
        modelSelect.innerHTML = '<option value="">Error loading models</option>';
    }
}

// Fill model fields when popular model is selected
function fillPopularModelFields() {
    const select = document.getElementById('popular_model_selector');
    const modelName = select.value;
    
    if (!modelName || !window.popularModels || !window.popularModels[modelName]) {
        return;
    }
    
    const m = window.popularModels[modelName];
    window.selectedModelName = modelName;
    
    document.getElementById('pred_params_m').value = m.params_m;
    document.getElementById('pred_gflops').value = m.gflops;
    document.getElementById('pred_gmacs').value = m.gmacs;
    document.getElementById('pred_size_mb').value = m.size_mb;
    document.getElementById('pred_latency').value = m.latency_avg_s;
    document.getElementById('pred_throughput').value = m.throughput_iter_per_s;
}

// Predict energy function (updated to use new API for popular models)
async function predictEnergy() {
    const outputDiv = document.getElementById('predict_output');
    const btn = document.getElementById('predict_energy_btn');
    
    // Get input values
    const deviceType = document.getElementById('pred_device_type').value;
    const paramsM = parseFloat(document.getElementById('pred_params_m').value);
    const gflops = parseFloat(document.getElementById('pred_gflops').value);
    const gmacs = parseFloat(document.getElementById('pred_gmacs').value);
    const sizeMb = parseFloat(document.getElementById('pred_size_mb').value);
    const latency = parseFloat(document.getElementById('pred_latency').value);
    const throughput = parseFloat(document.getElementById('pred_throughput').value);
    
    // Validation
    if (isNaN(paramsM) || isNaN(gflops) || isNaN(gmacs) || isNaN(sizeMb) || isNaN(latency) || isNaN(throughput)) {
        outputDiv.innerHTML = '<div style="color: var(--danger); font-weight: 500;">‚ö†Ô∏è Please fill all fields with valid numbers.</div>';
        return;
    }
    
    try {
        // Show loading state
        btn.disabled = true;
        btn.textContent = 'Predicting...';
        outputDiv.innerHTML = '<div style="color: var(--muted);">‚è≥ Computing energy prediction...</div>';
        
        // Prepare payload
        const payload = {
            device_type: deviceType,
            model_name: window.selectedModelName || 'custom_model',
            params_m: paramsM,
            gflops: gflops,
            gmacs: gmacs,
            size_mb: sizeMb,
            latency_avg_s: latency,
            throughput_iter_per_s: throughput
        };
        
        // Use new API for popular models or old API for available models
        let apiUrl = '/api/predict-energy';
        let isPopularModel = window.currentPredictionTab === 'popular';
        
        if (isPopularModel) {
            apiUrl = '/api/predict-energy-for-model';
        }
        
        // Call API
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (data.success && data.prediction) {
            // API response format
            const prediction = data.prediction;
            const energy = prediction.predicted_energy_mwh || 0;
            const category = prediction.energy_category;
            const recommendation = prediction.recommendation;
            const reason = prediction.reason;
            const modelDownloaded = prediction.model_downloaded;
            const mape = prediction.prediction_mape_pct;
            
            // Category icons and colors
            const categoryInfo = {
                'excellent': { icon: 'üü¢', label: 'Excellent', color: '#10b981', deployable: true },
                'good': { icon: 'üü°', label: 'Good', color: '#f59e0b', deployable: true },
                'acceptable': { icon: 'üü†', label: 'Acceptable', color: '#f97316', deployable: true },
                'high': { icon: 'üî¥', label: 'High Energy', color: '#ef4444', deployable: false }
            };
            
            const catInfo = categoryInfo[category] || { icon: '‚ö™', label: 'Unknown', color: '#6b7280', deployable: false };
            
            // Build recommendation text
            let recText = '';
            if (reason) {
                recText = reason;
            } else if (recommendation === 'deploy') {
                recText = 'This model is suitable for deployment on the selected device.';
            } else if (recommendation === 'deploy_with_caution') {
                recText = 'This model can be deployed but consider optimization to reduce energy consumption.';
            } else if (recommendation === 'not_recommend') {
                recText = 'This model has high energy consumption. Not recommended for deployment.';
            } else {
                recText = catInfo.deployable ? 'Model can be deployed.' : 'Consider a more efficient model.';
            }
            
            outputDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, ${catInfo.color}15, ${catInfo.color}05); border: 2px solid ${catInfo.color}; border-radius: 12px; padding: 20px; margin-top: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <span style="font-size: 48px;">${catInfo.icon}</span>
                        <div style="flex: 1;">
                            <div style="font-size: 28px; font-weight: 700; color: ${catInfo.color}; line-height: 1.2;">
                                ${energy.toFixed(2)} mWh
                            </div>
                            <div style="font-size: 13px; color: var(--muted); margin-top: 4px;">
                                ${catInfo.label} ${mape !== undefined && typeof mape === 'number' ? `‚Ä¢ Model MAPE: ${mape.toFixed(1)}%` : ''}
                            </div>
                        </div>
                        ${modelDownloaded === true ? '<span style="background: var(--success); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700;">‚úì DOWNLOADED</span>' : ''}
                        ${modelDownloaded === false ? '<span style="background: var(--warning); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700;">‚ö† NOT DOWNLOADED</span>' : ''}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 12px; margin-bottom: 12px;">
                        <div style="background: rgba(255,255,255,0.6); padding: 8px; border-radius: 6px;">
                            <div style="color: var(--muted); margin-bottom: 2px;">Device</div>
                            <div style="font-weight: 600;">${deviceType === 'jetson_nano' ? 'Jetson Nano' : 'Raspberry Pi 5'}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.6); padding: 8px; border-radius: 6px;">
                            <div style="color: var(--muted); margin-bottom: 2px;">Parameters</div>
                            <div style="font-weight: 600;">${paramsM.toFixed(2)}M</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.6); padding: 8px; border-radius: 6px;">
                            <div style="color: var(--muted); margin-bottom: 2px;">GFLOPs</div>
                            <div style="font-weight: 600;">${gflops.toFixed(2)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.6); padding: 8px; border-radius: 6px;">
                            <div style="color: var(--muted); margin-bottom: 2px;">Latency</div>
                            <div style="font-weight: 600;">${(latency * 1000).toFixed(1)}ms</div>
                        </div>
                    </div>
                    
                    <div style="padding: 12px; background: rgba(255,255,255,0.8); border-left: 3px solid ${catInfo.color}; border-radius: 6px; font-size: 13px;">
                        <div style="font-weight: 700; margin-bottom: 4px; color: var(--text);">üí° Recommendation:</div>
                        <div style="color: var(--muted);">${recText}</div>
                    </div>
                    
                    ${window.selectedModelName ? `
                        <div style="margin-top: 12px; text-align: right;">
                            <button onclick="deployPopularModel('${window.selectedModelName}')" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                                üöÄ Deploy ${window.selectedModelName}
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        } else {
            outputDiv.innerHTML = `<div style="color: var(--danger); font-weight: 500;">‚ùå ${data.error || 'Prediction failed'}</div>`;
        }
    } catch (err) {
        console.error('Prediction error:', err);
        outputDiv.innerHTML = `<div style="color: var(--danger); font-weight: 500;">‚ùå Network error: ${err.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Predict Energy';
    }
}

// Deploy popular model
async function deployPopularModel(modelName) {
    // Get selected device
    const selectedDevices = Array.from(document.querySelectorAll('.device-checkbox:checked'));
    
    if (selectedDevices.length === 0) {
        showAlert('Please select a device first', 'error');
        return;
    }
    
    const deviceCheckbox = selectedDevices[0];
    const deviceIp = deviceCheckbox.dataset.endpoint;
    
    if (!deviceIp) {
        showAlert('Device IP not available', 'error');
        return;
    }
    
    // Get energy budget (default 100 mWh)
    const energyBudget = 150;  // Higher budget for popular models
    
    // Call existing deploy function
    try {
        const response = await fetch('/api/deploy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model_name: modelName,
                bbb_ip: deviceIp,
                max_energy: energyBudget,
                force: true  // Allow deployment even if energy exceeds budget
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(`Successfully deployed ${modelName} to device`, 'success');
            loadDeploymentLogs();
        } else {
            showAlert(`Deployment failed: ${data.error}`, 'error');
        }
    } catch (err) {
        console.error('Deployment error:', err);
        showAlert(`Deployment failed: ${err.message}`, 'error');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    updateMapeValues();
    loadPopularModels();  // Load popular models
    
    // Attach event listeners
    const deviceSelect = document.getElementById('pred_device_type');
    const predictBtn = document.getElementById('predict_energy_btn');
    
    if (deviceSelect) {
        deviceSelect.addEventListener('change', onDeviceTypeChange);
    }
    
    if (predictBtn) {
        predictBtn.addEventListener('click', predictEnergy);
    }
});
</script>